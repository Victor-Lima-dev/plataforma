<div class="container-fluid main">

    <div class="bloco1-perfil">

        <div class="bloco1 container">
            <div class="bloco1-DivParagrafo">
                <p class='bloco1-Paragrafo paragrafo'>Um lugar para auxiliar seus estudos</p>
            </div>
            <div class="bloco1-DivTitulo">
                <h2 class="bloco1-Titulo titulo">Bem vindo a Plataforma</h2>
                <button class="bloco1-Botao botao">Continue Focado</button>
            </div>

            <div class="bloco1-divDestaques">
                <div class="bloco1-BoxDestaque" onclick="executeCallbackAfterClearingElement(verificarBloco2Existe)">
                    <span class="span-Destaque">Create</span>
                    <p class="paragrafo-Destaque">Criar Questão</p>
                </div>
                <div class="bloco1-BoxDestaque" onclick="executeCallbackAfterClearingElement(listarTodasPerguntas);">
                    <span class="span-Destaque">Review</span>
                    <p class="paragrafo-Destaque">Listar Todas as Questões</p>
                </div>
                <div class="bloco1-BoxDestaque">
                    <span class="span-Destaque">Review</span>
                    <p class="paragrafo-Destaque">Questões para Responder</p>
                </div>

            </div>
        </div>

        <div class="perfil container">
            <div class="perfil-divTitulo">
                <p class="perfil-titulo">Usuário</p>
                <span class="perfil-span span-metrica">30% da meta diária batida</span>
            </div>
            <div class="perfil-divMetricas">
                <div class="perfil-boxMetrica">
                    <span class="span-metrica">Exercícios Diários</span>
                    <p class="paragrafo-metrica">100</p>
                </div>


                <div class="perfil-boxMetrica">
                    <span class="span-metrica">Total de Exercícios</span>
                    <p class="paragrafo-metrica">100</p>
                </div>
            </div>

            <div class="perfil-divQuantidades">
                <div class="perfil-boxQuantidades">
                    <p class="perfil-quantidade paragrafo-metrica">5</p>
                    <span class="perfil-quantidadeSpan span-metrica ">Questões</span>
                </div>
                <div class="perfil-boxQuantidades">
                    <p class="perfil-quantidade paragrafo-metrica">5</p>
                    <span class="perfil-quantidadeSpan span-metrica">Anotações</span>
                </div>
                <div class="perfil-boxQuantidades">
                    <p class="perfil-quantidade paragrafo-metrica">5</p>
                    <span class="perfil-quantidadeSpan span-metrica">Listas</span>
                </div>
            </div>
        </div>
    </div>

    <div id="quadroPrincipal">



    </div>


</div>

<script>



    function getFormData() {
        // Seleciona o formulário
        var form = document.getElementById('formCriarQuestao');

        //remover o evento de recarregar a página
        form.addEventListener('submit', function (event) {
            event.preventDefault();
        });

        // selecionar os inputs
        var enunciado = document.getElementById('enunciado').value;
        var justificativa = document.getElementById('justificativa').value;

        // criar um objeto com os dados
        var formData = {
            enunciado: enunciado,
            justificativa: justificativa,
        };

        // Itera sobre os elementos do formulário
        for (var i = 1; i <= 4; i++) {
            formData['alternativa' + i] = document.getElementById('alternativa' + i).value;
            formData['justificativaAlternativa' + i] = document.getElementById('justificativaAlternativa' + i).value;
        }

        const guidId = "0e7745b3-fea7-40ed-8445-ad622e95904f";

        var questaoMontada = {
            RequisicaoId: guidId,
            Conteudo: enunciado,
            Valided: false,
            Respostas: [],
            Tags: [
                {
                    Texto: enunciado,
                    Perguntas: []
                }
            ],
            Explicacao: justificativa,
            Erro: ""
        }



        //adicionar as respostas usando o for
        for (var i = 1; i <= 4; i++) {
            questaoMontada.Respostas.push({
                Conteudo: formData['alternativa' + i],
                PerguntaId: guidId,
                Correta: false,
                Valided: false,
                Erro: formData['justificativaAlternativa' + i]
            });
        }

        //verificar qual inputRadio esta marcado, o ultimo caracter é o número da alternativa
        for (var i = 1; i <= 4; i++) {
            if (document.getElementById('inputRadio' + i).checked) {
                questaoMontada.Respostas[i - 1].Correta = true;
            }
        }


        return questaoMontada;
    }

    function revelarJustificativas() {
        //remover o evento de recarregar a página
        event.preventDefault();
        var justificativas = document.querySelectorAll('.criarQuestao-Justificativa');
        justificativas.forEach(function (justificativa) {
            justificativa.classList.toggle('d-none');
        });
    }



    function criarQuestaoFetch() {
        var formData = getFormData();

        fetch('http://localhost:5084/api/plataforma/criarquestao', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
        })
            .then((response) => response.json())
            .then((data) => {
                console.log('Success:', data);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
    }

    function criarQuestaoGerarHTML() {



        //selecionar o elemento de id 'quadroPrincipal'

        var mainElement = document.getElementById('quadroPrincipal');

        // Define o código HTML que você deseja inserir
        var html = `
        <div class="bloco2">
        <div class="criarQuestao">

            <form class="criarQuestao" id="formCriarQuestao">


                <div class="criarQuestaoDiv">

                    <div class="criarQuestaoDiv">
                        <h2 class="criarQuestao-Titulo titulo">Criar Questão </h2>
                        <h3 class="criarQuestao-Titulo">Enunciado</h3>
                        <div class="input-group">
                            <textarea class="form-control" aria-label="With textarea" id="enunciado"></textarea>
                        </div>
                    </div>


                    <div class="criarQuestaoDiv">
                        <h3 class="criarQuestao-Titulo">Justificativa</h3>
                        <div class="input-group">

                            <textarea class="form-control" aria-label="With textarea" id="justificativa"></textarea>
                        </div>

                    </div>
                </div>


                <div class="criarQuestao-Alternativas criarQuestaoDiv">
                    <div class="criarQuestao-AlternativasTitulo">
                        <h3 class="criarQuestao-Titulo">Alternativas</h3>
                        <button onclick="revelarJustificativas()">Adicionar Justificativas</button>
                    </div>

                    <div class="input-group">
                        <span class="input-group-text">Alternativa</span>
                        <textarea class="form-control" aria-label="With textarea" id="alternativa1"></textarea>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="flexRadioDefault" id="inputRadio1">
                            <label class="form-check-label" for="inputRadio1">
                                Default radio
                            </label>
                        </div>
                    </div>
                    <div class="input-group criarQuestao-Justificativa d-none">
                        <span class="input-group-text span-justificativa">Justificativa</span>
                        <textarea class="form-control" aria-label="With textarea"
                            id="justificativaAlternativa1"></textarea>
                    </div>
                    <div class="input-group">
                        <span class="input-group-text">Alternativa</span>
                        <textarea class="form-control" aria-label="With textarea" id="alternativa2"></textarea>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="flexRadioDefault" id="inputRadio2">
                            <label class="form-check-label" for="inputRadio2">
                                Default radio
                            </label>
                        </div>
                    </div>
                    <div class="input-group criarQuestao-Justificativa d-none">
                        <span class="input-group-text span-justificativa">Justificativa</span>
                        <textarea class="form-control" aria-label="With textarea"
                            id="justificativaAlternativa2"></textarea>

                    </div>
                    <div class="input-group">
                        <span class="input-group-text">Alternativa</span>
                        <textarea class="form-control" aria-label="With textarea" id="alternativa3"></textarea>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="flexRadioDefault" id="inputRadio3">
                            <label class="form-check-label" for="inputRadio3">
                                Default radio
                            </label>
                        </div>
                    </div>
                    <div class="input-group criarQuestao-Justificativa d-none">
                        <span class="input-group-text span-justificativa">Justificativa</span>
                        <textarea class="form-control" aria-label="With textarea"
                            id="justificativaAlternativa3"></textarea>
                    </div>
                    <div class="input-group">
                        <span class="input-group-text">Alternativa</span>
                        <textarea class="form-control" aria-label="With textarea" id="alternativa4"></textarea>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="flexRadioDefault" id="inputRadio4">
                            <label class="form-check-label" for="inputRadio4">
                                Default radio
                            </label>
                        </div>
                    </div>
                    <div class="input-group criarQuestao-Justificativa d-none">
                        <span class="input-group-text span-justificativa">Justificativa</span>
                        <textarea class="form-control" aria-label="With textarea"
                            id="justificativaAlternativa4"></textarea>
                    </div>
                </div>

                <div class="CriarQuestao-botaoSalvar">

                    <button type="submit" id="botaoSalvar" class="bloco1-Botao botaoSalvar"
                        onclick="criarQuestaoFetch()">Salvar</button>
                </div>

            </form>


        </div>
        <div class="requisitosQuestao">
            <div class="requisitosQuestao-divTitulo">
                <h3 class="requisitosQuestao-titulo">Requisitos para criar a Questão</h3>
                <p class="requisitosQuestao-paragrafo ">A Questão vai possuir:</p>
                <ul class="requisitosQuestao-ul">
                    <li class="requisitosQuestao-li">- 4 alternativas <span class="span-Destaque">obrigatório</span>
                    </li>
                    <li class="requisitosQuestao-li">- Explicação da resposta correta <span class="span-Destaque">
                            obrigatório</span></li>
                    <li class="requisitosQuestao-li">- Justificativa das Alternativas Erradas <span
                            class="span-Destaque"> não obrigatório</span></li>
                </ul>
            </div>
        </div>
    </div> 
    `;

        // Insere o código HTML como o último filho do elemento 'main'
        mainElement.insertAdjacentHTML('beforeend', html);
    }


    function verificarBloco2Existe() {
        // Tenta selecionar o elemento
        var element = document.querySelector('.bloco2');

        // Verifica se o elemento existe
        if (element) {
            console.log('O elemento existe!');
        } else {
            criarQuestaoGerarHTML();
        }
    }

    var perguntas = [
        {
            Id: "123456",
            RequisicaoId: 'guid1',
            Conteudo: 'Qual é a capital da França?',
            Valided: false,
            Respostas: [
                { Id: "123", Conteudo: 'Paris', PerguntaId: '123456', Correta: true, Valided: false, Erro: '' },
                { Id: "134", Conteudo: 'Londres', PerguntaId: '123456', Correta: false, Valided: false, Erro: '' },
                { Id: "234", Conteudo: 'Berlim', PerguntaId: '123456', Correta: false, Valided: false, Erro: '' },
                { Id: "12234", Conteudo: 'Madrid', PerguntaId: '123456', Correta: false, Valided: false, Erro: '' }
            ],
            Tags: [
                { Texto: 'Geografia' },
                { Texto: 'Capitais' }
            ],
            Explicacao: 'Paris é a capital da França.',
            Erro: ""
        },
        {
            Id: "1234563",
            RequisicaoId: 'guid2',
            Conteudo: 'Quem escreveu "Dom Quixote"?',
            Valided: false,
            Respostas: [
                { Id: "12232334", Conteudo: 'Miguel de Cervantes', PerguntaId: '1234563', Correta: true, Valided: false, Erro: '' },
                { Id: "1234323232", Conteudo: 'William Shakespeare', PerguntaId: '1234563', Correta: false, Valided: false, Erro: '' },
                { Id: "1232323234", Conteudo: 'J.K. Rowling', PerguntaId: '1234563', Correta: false, Valided: false, Erro: '' },
                { Id: "1233232324", Conteudo: 'Stephen King', PerguntaId: '1234563', Correta: false, Valided: false, Erro: '' }
            ],
            Tags: [
                { Texto: 'Literatura' },
                { Texto: 'Autores' }
            ],
            Explicacao: 'Dom Quixote foi escrito por Miguel de Cervantes.',
            Erro: ""
        },
        {
            Id: "12345621",
            RequisicaoId: 'guid3',
            Conteudo: 'Qual é a fórmula da água?',
            Valided: false,
            Respostas: [
                { Id: "123323232324", Conteudo: 'H2O', PerguntaId: '12345621', Correta: true, Valided: false, Erro: '' },
                { Id: "12312331234", Conteudo: 'CO2', PerguntaId: '12345621', Correta: false, Valided: false, Erro: '' },
                { Id: "123213213124", Conteudo: 'O2', PerguntaId: '12345621', Correta: false, Valided: false, Erro: '' },
                { Id: "12332131231234", Conteudo: 'H2', PerguntaId: '12345621', Correta: false, Valided: false, Erro: '' }
            ],
            Tags: [
                { Texto: 'Química' },
                { Texto: 'Fórmulas' }
            ],
            Explicacao: 'A fórmula da água é H2O.',
            Erro: ""
        }
    ];

    function listarTodasPerguntas() {

        

        var htmlbase =
            `
<div class="bloco3">
<div class="divQuestoes">
    <div class="questoesTitulo">
        <h2 class = "titulo">Todas as Perguntas</h2>
    </div>
    <div class="listaQuestoes">

    </div>


</div>

<div class="infoQuestoes">

</div>
</div>`

        var quadro = document.getElementById('quadroPrincipal');

        quadro.insertAdjacentHTML('beforeend', htmlbase);


        // Seleciona o elemento onde as perguntas serão inseridas
        var divQuestoes = document.querySelector('.listaQuestoes');

        var contagemQuestoes = questoes.length;

        // Itera sobre a lista de perguntas
        for (var i = 0; i < questoes.length; i++) {
            var questaoEnviada = questoes[i]
            // Cria o HTML para a pergunta atual
            var html = `
                <div class="boxQuestao" onclick="executeCallbackAfterClearingElement(() => generateQuestionHTML(questoes[${i}]))">
                    <p class="questaoEnunciado">${questoes[i].conteudo}</p>
                    <div class="boxTags">`;

            // Adiciona as tags da pergunta ao HTML
            for (var j = 0; j < questoes[i].taGs.length; j++) {
                html += `<span class="tag span-Destaque">${questoes[i].taGs[j].texto}</span>`;
            }

            html += `
                    </div>
                </div>`;

            // Insere o HTML da pergunta no elemento 'divQuestoes'
            divQuestoes.insertAdjacentHTML('beforeend', html);
        }
    }




    function executeCallbackAfterClearingElement(callback) {
        // Seleciona o elemento com o id 'quadroPrincipal'
        var quadroPrincipal = document.getElementById('quadroPrincipal');

        // Verifica se o elemento tem filhos
        if (quadroPrincipal.hasChildNodes()) {
            // Se tiver, remove todos os filhos
            while (quadroPrincipal.firstChild) {
                quadroPrincipal.removeChild(quadroPrincipal.firstChild);
            }
        }

        // Executa a função callback
        callback();
    }


    function generateQuestionHTML(question) {
        var quadro = document.getElementById('quadroPrincipal');
        // Cria as tags
        var tagsHTML = question.taGs.map(tag => `<span class="ResponderQuestaoTAG tag span-Destaque">${tag.texto}</span>`).join('');

        //transformar os ids em string
        var perguntaId = question.id.toString();

        for (var i = 0; i < question.respostas.length; i++) {
            question.respostas[i].id = question.respostas[i].id.toString();
        }

        // Cria as alternativas
        var alternativasHTML = question.respostas.map((resposta, index) => 
        `
        <div class="boxAlternativa" id="${resposta.id}" onclick="document.getElementById('${resposta.id}').click(); selecionarAlternativa('${resposta.perguntaId}', '${resposta.id}');">
            <div class="form-check inputAlternativa form-check-inline">
                <input class="form-check-input inputAlternativaResponder" type="radio" name="inlineRadioOptions" id="input${resposta.id}" value="option${index}">
                <label class="form-check-label labelInput" for="input${resposta.id}">${resposta.conteudo}</label>
            </div>
        </div>

        
        <div class="boxAlternativaJustificativa d-none" id="${resposta.id}Alternativa" >
            <p class="alternativaJustificativa">${resposta.Erro}
                </p>
        </div>
    `).join('');

        // Cria o HTML completo
        var html = `
        <div class = "bloco4">
        <div class="divResponderQuestao">
            <div class="ResponderQuestaoTags">
                ${tagsHTML}
            </div>
            <p class="enunciado">${question.conteudo}</p>
            <div class="boxResponderQuestaoAlternativas">
                ${alternativasHTML}
            </div>
        </div>

          <div class="infoQuestoes">

            </div>
             </div>
    `;

        // Adiciona o HTML ao DOM
        quadro.insertAdjacentHTML('beforeend', html);
    }


    function selecionarAlternativa(perguntaId, respostaId) {
        var inputs = document.querySelectorAll('.inputAlternativaResponder');

        var alternativaSelecionada = null;

        inputs.forEach(function (input) {
            if (input.checked) {


                responderQuestao(respostaId, perguntaId)
            }
        });
    }

    function responderQuestao(alternativaId, perguntaId) {

        var perguntaId = perguntaId.toString();
        var alternativaId = alternativaId.toString();

        var pergunta = questoes.find(pergunta => pergunta.id === perguntaId);

        var alternativa = pergunta.respostas.find(resposta => resposta.id === alternativaId);

        if (alternativa.correta) {
            animacaoResposta(true, alternativaId);
        }
        else {
            animacaoResposta(false, alternativaId);
        }
    }

    function animacaoResposta(bool, inputId) {
        var input = document.getElementById(inputId);
        var alternativaJustificativa = document.getElementById(inputId + 'Alternativa');
       
        if (bool) {
            input.classList.add('respostaCorreta');
            //remover a classe d-none
            alternativaJustificativa.classList.remove('d-none');
        }
        else {
            input.classList.add('respostaErrada');
            alternativaJustificativa.classList.remove('d-none');
        }
    }

    function getTodasPerguntas()
    {
        fetch('http://localhost:5084/api/plataforma/ListarQuestoes', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then((response) => response.json())
            .then((data) => {

                var perguntas = Object.values(data);
                console.log(perguntas);

                questoes = perguntas; 

            })
            .catch((error) => {

                console.error('Error:', error);

            });
    }


    var questoes = []

    getTodasPerguntas();

</script>